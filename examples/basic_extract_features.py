# -*- coding: utf-8 -*-
"""
Created on Fri Dec  1 20:09:53 2023

@author: Administrator
"""

#! -*- coding: utf-8 -*-
# 测试代码可用性: 提取特征

import os
os.environ["TF_CPP_MIN_LOG_LEVEL"] = "3"
os.environ["KERAS_BACKEND"] = "torch"
os.environ["FLASH_ATTN"] = "0"#启动flash-attn


import numpy as np
from bert4keras3.backend import keras,ops
keras.backend.set_floatx('bfloat16')
from bert4keras3.models import build_transformer_model
from bert4keras3.tokenizers import Tokenizer
from bert4keras3.snippets import to_array

#bert from 
#model download form https://open.zhuiyi.ai/releases/nlp/models/zhuiyi/chinese_roberta_L-4_H-312_A-12.zip
config_path = 'chinese_wobert_L-12_H-768_A-12/bert_config.json'
checkpoint_path = 'chinese_wobert_L-12_H-768_A-12/bert_model.ckpt'
dict_path = 'chinese_wobert_L-12_H-768_A-12/vocab.txt'

tokenizer = Tokenizer(dict_path, do_lower_case=True)  # 建立分词器
model = build_transformer_model(config_path, checkpoint_path)  # 建立模型，加载权重

# 编码测试
token_ids, segment_ids = tokenizer.encode(u'语言模型')
token_ids, segment_ids = to_array([token_ids], [segment_ids])



print('\n ===== predicting =====\n')
print(model.predict([token_ids, segment_ids]))
model.predict([np.zeros([1024,32]),np.zeros([1024,32])],batch_size=16)
model.predict([np.zeros([1024,32]),np.zeros([1024,32])],batch_size=16,verbose=1)


"""
jax + keras3
1/1 ━━━━━━━━━━━━━━━━━━━━ 4s 4s/step
[[[ 0.38988823 -0.01438433  1.5175353  ... -0.24279015  0.0602929
   -0.5276529 ]
  [-0.7205516  -0.18944462  1.2657804  ... -1.0808806  -0.07783457
    0.02543534]
  [ 0.2350443  -0.59266067  1.0074751  ... -0.870237   -0.41888168
   -0.20036128]
  [-0.46260795  0.2652816   1.2453502  ... -0.5627243  -0.51681757
   -0.75340915]
  [-1.1026425   0.4773692   1.5190558  ... -0.9399947  -1.3550612
   -0.25996414]
  [ 0.3899519  -0.01446744  1.5174159  ... -0.24278383  0.06029204
   -0.5276821 ]]]
128/128 ━━━━━━━━━━━━━━━━━━━━ 6s 2ms/step  
128/128 ━━━━━━━━━━━━━━━━━━━━ 0s 2ms/step

    keras3+torch

    1/1 ━━━━━━━━━━━━━━━━━━━━ 0s 46ms/step
[[[ 0.39091924 -0.01291097  1.518835   ... -0.24233319  0.0598794
   -0.52755356]
  [-0.7224981  -0.18857734  1.264718   ... -1.0812999  -0.07896316
    0.02745117]
  [ 0.23513678 -0.5940911   1.0072188  ... -0.87042177 -0.41914654
   -0.200799  ]
  [-0.4600449   0.26725328  1.2442416  ... -0.5605526  -0.52189654
   -0.75340474]
  [-1.1030028   0.47758132  1.5185008  ... -0.9410242  -1.352944
   -0.26015034]
  [ 0.39091927 -0.01291088  1.5188353  ... -0.24233319  0.05987941
   -0.5275535 ]]]
128/128 ━━━━━━━━━━━━━━━━━━━━ 5s 42ms/step
128/128 ━━━━━━━━━━━━━━━━━━━━ 5s 42ms/step

jax+bf16+flash-att
1/1 ━━━━━━━━━━━━━━━━━━━━ 4s 4s/step
[[[0.330078 -0.570312 0.535156 ... -0.178711 0.0795898 -0.257812]
  [1.24219 -0.546875 0.392578 ... 0.0874023 -0.117188 -0.769531]
  [0.316406 -0.326172 0.328125 ... 0.216797 0.185547 -0.667969]
  [0.457031 -0.0537109 0.503906 ... -0.0708008 -0.135742 -0.291016]
  [0.240234 -0.200195 0.123047 ... -0.460938 -0.097168 -0.316406]
  [0.330078 -0.570312 0.535156 ... -0.174805 0.0776367 -0.259766]]]
64/64 ━━━━━━━━━━━━━━━━━━━━ 4s 5ms/step 
64/64 ━━━━━━━━━━━━━━━━━━━━ 0s 4ms/step
jax+bf16

1/1 ━━━━━━━━━━━━━━━━━━━━ 4s 4s/step
[[[0.332031 -0.574219 0.535156 ... -0.175781 0.0771484 -0.265625]
  [1.25781 -0.539062 0.384766 ... 0.0844727 -0.111816 -0.777344]
  [0.324219 -0.324219 0.330078 ... 0.21582 0.183594 -0.660156]
  [0.460938 -0.0551758 0.498047 ... -0.0766602 -0.128906 -0.296875]
  [0.245117 -0.201172 0.11084 ... -0.474609 -0.103516 -0.314453]
  [0.332031 -0.574219 0.535156 ... -0.175781 0.0751953 -0.263672]]]
128/128 ━━━━━━━━━━━━━━━━━━━━ 4s 4ms/step 
128/128 ━━━━━━━━━━━━━━━━━━━━ 0s 3ms/step

torch+bf16
1/1 ━━━━━━━━━━━━━━━━━━━━ 0s 46ms/step
[[[0.330078 -0.566406 0.546875 ... -0.169922 0.0742188 -0.267578]
  [1.25 -0.542969 0.402344 ... 0.074707 -0.111328 -0.761719]
  [0.320312 -0.302734 0.345703 ... 0.238281 0.169922 -0.660156]
  [0.455078 -0.0373535 0.511719 ... -0.0810547 -0.145508 -0.291016]
  [0.227539 -0.193359 0.111328 ... -0.466797 -0.0996094 -0.320312]
  [0.330078 -0.566406 0.546875 ... -0.173828 0.0742188 -0.265625]]]
64/64 ━━━━━━━━━━━━━━━━━━━━ 3s 44ms/step
64/64 ━━━━━━━━━━━━━━━━━━━━ 3s 43ms/step

"""

